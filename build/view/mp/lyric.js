/*!1.0.2 kooboy_li@163.com*/
import t from"../../lib/magix.js";import e from"./player.js";let i=/((?:\[[0-9:\.]+\])+)([^\r\n]*)/g,s=/\[offset\s*:\s*(\d+)\]/i,l=/\[([0-9\.:]+)\]/g,h=(t,e)=>t.time-e.time,r=[{text:""},{text:"\u6b4c\u8bcd\u52a0\u8f7d\u4e2d..."}],_=[{text:""},{text:"\u83b7\u53d6\u6b4c\u8bcd\u5931\u8d25"}];export default t.View.extend({tmpl:(t,e,i,s)=>{let l,h,r,_=[],{lyrics:a}=t;for(let t=0,i=a,n=i.length;t<n;t++){let a=i[t];r=[e(0,0,s(a.text))],h="feY",a.active&&(h+=" feZ"),l=[e("div",{title:s(a.text),class:h},r)],_.push(...l)}return e(i,0,_)},init(){e.on("_t",t=>{this._H(t.song.sid)}),e.on("_I",t=>{this._J(t.current)}),e.on("_u",()=>{this._K()})},_K(){delete this._L,delete this._M,delete this._N,delete this._O,delete this._P,this._J(0)},async _H(r){let _=t.mark(this,"_H");try{let{lyric:t}=await e._Q(r);_()&&(this._L=(t=>{let e=0,r=[];return t.replace(s,(t,i)=>(e=parseFloat(i)/1e3,"")).replace(i,(t,i,s)=>{i.replace(l,(t,i)=>{let l=0,h=(i=i.split(":")).length-1;for(let t=0;t<=h;t++)l+=i[t]*Math.pow(60,h-t);l-=e,isNaN(l)||r.push({time:l,text:s})})}),r.length<2&&r.push({time:-1,text:""}),r=r.sort(h)})(t))}catch(t){this._P=!0}},_J(t){let e=this._L;if(e){let i=0,s=[];for(;i<e.length;i++){if(e[i].time>t)break}let l=Math.max(i-2,0),h=Math.min(e.length,i+1);if(0==l&&e.length>2&&h-l<3&&h++,h==e.length&&e.length>2&&h-l<3&&l--,(i-=1)<0&&(i=0),this._N!=h||this._M!=l||this._O!=i){this._N=h,this._M=l,this._O=i;for(let t=l;t<h;t++)s.push({text:e[t].text,active:t==i});this.digest({lyrics:s})}}else this.digest({lyrics:this._P?_:r})},render(){this.digest({lyrics:r})}});