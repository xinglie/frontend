/*!1.0.2 kooboy_li@163.com*/
import t from"../../lib/magix.js";import e from"./player.js";let i=/((?:\[[0-9:\.]+\])+)([^\r\n]*)/g,s=/\[offset\s*:\s*(\d+)\]/i,l=/\[([0-9\.:]+)\]/g,h=(t,e)=>t.time-e.time,r=[{text:""},{text:"\u6b4c\u8bcd\u52a0\u8f7d\u4e2d..."}],_=[{text:""},{text:"\u83b7\u53d6\u6b4c\u8bcd\u5931\u8d25"}];export default t.View.extend({tmpl:(t,e,i,s)=>{let l,h,r,_=[],{lyrics:a}=t;for(let t=0,i=a,n=i.length;t<n;t++){let a=i[t];r=[e(0,0,s(a.text))],h="feW",a.active&&(h+=" feX"),l=[e("div",{title:s(a.text),class:h},r)],_.push(...l)}return e(i,0,_)},init(){e.on("_v",t=>{this._L(t.song.sid)}),e.on("_M",t=>{this._N(t.current)}),e.on("_w",()=>{this._O()})},_O(){delete this._P,delete this._Q,delete this._R,delete this._S,delete this._T,this._N(0)},async _L(t){let r=this.getMarker("_L");try{let{lyric:_}=await e._U(t);r()&&(this._P=(t=>{let e=0,r=[];return t.replace(s,(t,i)=>(e=parseFloat(i)/1e3,"")).replace(i,(t,i,s)=>{i.replace(l,(t,i)=>{let l=0,h=(i=i.split(":")).length-1;for(let t=0;t<=h;t++)l+=i[t]*Math.pow(60,h-t);l+=e,isNaN(l)||r.push({time:l,text:s})})}),r=r.sort(h)})(_))}catch(t){this._T=!0}},_N(t){let e=this._P;if(e){let i=0,s=[];for(;i<e.length;i++){if(e[i].time>t)break}let l=Math.max(i-2,0),h=Math.min(e.length,i+1);if(0==l&&e.length>2&&h-l<3&&h++,h==e.length&&e.length>2&&h-l<3&&l--,(i-=1)<0&&(i=0),this._R!=h||this._Q!=l||this._S!=i){this._R=h,this._Q=l,this._S=i;for(let t=l;t<h;t++)s.push({text:e[t].text,active:t==i});this.digest({lyrics:s})}}else this.digest({lyrics:this._T?_:r})},render(){this.digest({lyrics:r})}});