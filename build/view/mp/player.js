/*!1.0.2 kooboy_li@163.com*/
import t from"../../lib/magix.js";let e="https://jirenguapi.applinzi.com/fm",i=[],s=[],h=new t.Cache(200,50);export default Object.assign({_V:()=>fetch(`${e}/getChannels.php`).then(t=>t.json()),_W:t=>fetch(`${e}/getSong.php?channel=${t}`).then(t=>t.json()),_U(t){let i=`${e}/getLyric.php?sid=${t}`;return h.has(i)?Promise.resolve(h.get(i)):fetch(i).then(t=>t.json()).then(t=>(h.set(i,t),Promise.resolve(t)))},async _p(){let{channels:t}=await this._V();return{active:t[0],channels:t}},_aa(e){if(this._X){clearTimeout(this._Y);let i=this._Z;i||(i={play:!1,buffer:!1});let s=["play","buffer"];for(let h of s)t.has(e,h)||(e[h]=i[h]);this._Z=e,this._Y=setTimeout(()=>{let t=!1;if(i=this._a_){for(let h of s)if(i[h]!=e[h]){t=!0;break}}else t=!0;t&&this.fire("_u",this._a_=e)},50)}},_ac(){if(!this._X){let t,e=new Audio;e.onerror=(()=>{clearTimeout(t),t=setTimeout(()=>{this.fire("_r")},2e3)}),e.onended=(()=>{clearTimeout(t),t=setTimeout(()=>{this.fire("_r")},1e3)}),e.oncanplay=(()=>{this._aa({buffer:!1})}),e.onwaiting=(()=>{this._aa({buffer:!0})}),e.ontimeupdate=(()=>{let t=e.buffered,i=0;t.length&&(i=t.end(t.length-1)/e.duration),this.fire("_M",{duration:e.duration,current:e.currentTime,buffered:i})}),e.onplay=(()=>{this._aa({play:!0})}),e.onpause=(()=>{this._aa({play:e.ended})}),e.onloadedmetadata=(()=>{let t=this._ab,e=!1;for(let i of s)if(i.sid==t.sid){e=!0;break}if(!e)for(let s of i)if(s.sid==t.sid){e=!0;break}e||s.push(t),s.length>50&&s.shift(),this.fire("_v",{song:t})}),this._X=e}},_ad(t){this._ac(),this._X.src=t.url,this._X.play().catch(t=>{}),this._ab=t},_ae(t){let e=this._X.seekable,i=e.length;if(i){let s=e.start(0),h=e.end(i-1);t>=s&&t<=h&&(this._X.currentTime=t)}else{let t=this._X.buffered;if(t.length){let e=t.end(t.length-1);this._X.currentTime=e}}},async _s(e,h){if(this._A(),this._aa({buffer:!0}),h||(h=0==i.length),h)try{let i=t.getMarker(this,"_s"),{song:s}=await this._W(e);i()&&(this._ad(s[0]),this.fire("_w",{song:s[0]}))}catch(t){clearTimeout(this._af),this._af=setTimeout(()=>{this._s(e,h)},2e3)}else{let t=i.pop();s.push(t),this._ad(t),this.fire("_w",{song:t})}},_H(){if(s.length>1){this._A(),this._aa({buffer:!0});let t=s.pop();i.push(t),t=s[s.length-1],this._ad(t),this.fire("_w",{song:t})}},_z:()=>s.length>1,_D(t){this._X&&(this._X.volume=t)},_A(){this._X&&this._X.pause()},_B(){this._X&&this._X.play()},_t(){this._X&&(this._X.currentTime=0,this._X.play())},_x(){if(s.length>1){let t=s[s.length-2];return"\u4e0a\u4e00\u9996\uff1a"+t.title+"-"+t.artist}return"\u4e0a\u4e00\u9996\uff1a\u6682\u65e0\u5386\u53f2\u6b4c\u66f2"},_y(){if(i.length){let t=i[i.length-1];return"\u4e0b\u4e00\u9996\uff1a"+t.title+"-"+t.artist}return"\u4e0b\u4e00\u9996\uff1a\u968f\u673a\u6b4c\u66f2"}},t.Event);