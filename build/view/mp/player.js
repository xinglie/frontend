/*!1.0.2 kooboy_li@163.com*/
import t from"../../lib/magix.js";let e="https://jirenguapi.applinzi.com/fm",i=[],s=[],h=new t.Cache(200,50);export default Object.assign({_R:()=>fetch(`${e}/getChannels.php`).then(t=>t.json()),_S:t=>fetch(`${e}/getSong.php?channel=${t}`).then(t=>t.json()),_Q(t){let i=`${e}/getLyric.php?sid=${t}`;return h.has(i)?Promise.resolve(h.get(i)):fetch(i).then(t=>t.json()).then(t=>(h.set(i,t),Promise.resolve(t)))},async _n(){let{channels:t}=await this._R();return{active:t[0],channels:t}},_X(e){if(this._T){clearTimeout(this._U);let i=this._V;i||(i={play:!1,buffer:!1});let s=["play","buffer"];for(let h of s)t.has(e,h)||(e[h]=i[h]);this._V=e,this._U=setTimeout(()=>{let t=!1;if(i=this._W){for(let h of s)if(i[h]!=e[h]){t=!0;break}}else t=!0;t&&this.fire("_s",this._W=e)},50)}},_Y(){let t=this._T;if(t){let e=t.buffered,i=0;e.length&&(i=e.end(e.length-1)/t.duration),this.fire("_I",{duration:t.duration,current:t.currentTime,buffered:i})}},_aa(){if(!this._T){let t,e=new Audio;e.onprogress=(()=>{this._Y()}),e.onerror=(()=>{clearTimeout(t),t=setTimeout(()=>{this.fire("_p")},2e3)}),e.onended=(()=>{clearTimeout(t),t=setTimeout(()=>{this.fire("_p")},1e3)}),e.oncanplay=(()=>{this._X({buffer:!1})}),e.onwaiting=(()=>{this._X({buffer:!0})}),e.ontimeupdate=(()=>{this._Z||this._Y()}),e.onplay=(()=>{this._X({play:!0})}),e.onpause=(()=>{this._X({play:e.ended})}),e.onloadedmetadata=(()=>{let t=this._a_,e=!1;for(let i of s)if(i.sid==t.sid){e=!0;break}if(!e)for(let s of i)if(s.sid==t.sid){e=!0;break}e||s.push(t),s.length>50&&s.shift(),this.fire("_t",{song:t})}),this._T=e}},_ab(t){this._aa(),this._T.src=t.url,this._T.play().catch(t=>{}),this._a_=t},_ac(t){if(this._T){let e=this._T.seekable,i=e.length;if(i){let s=e.start(0),h=e.end(i-1);t>=s&&t<=h&&(this._T.currentTime=t)}else{let t=this._T.buffered;if(t.length){let e=t.end(t.length-1);this._T.currentTime=e}}}},_ae(t,e,i){clearTimeout(this._ad),this._ad=setTimeout(()=>{this._q(t,e)},i)},async _q(e,h){if(this._y(),this._X({buffer:!0}),h||(h=0==i.length),h)try{let i=t.mark(this,"_q"),{song:s}=await this._S(e);if(i()){let t=s[0];t.url?(this.fire("_u",{song:t}),this._ab(t)):this._ae(e,h,50)}}catch(t){this._ae(e,h,2e3)}else{let t=i.pop();s.push(t),this._ab(t),this.fire("_u",{song:t})}},_D(){if(s.length>1){this._y(),this._X({buffer:!0});let t=s.pop();i.push(t),t=s[s.length-1],this._ab(t),this.fire("_u",{song:t})}},_F(){return this._T},_x:()=>s.length>1,_af(t){this._T&&(this._T.volume=t)},_y(){this._T&&this._T.pause()},_z(){this._T&&this._T.play()},_ag(){let t=this._T;return!!t&&(t.muted=!t.muted,t.muted)},_r(){this._T&&(this._T.currentTime=0,this._T.play())},_v(){if(s.length>1){let t=s[s.length-2];return"\u4e0a\u4e00\u9996\uff1a"+t.title+"-"+t.artist}return"\u4e0a\u4e00\u9996\uff1a\u6682\u65e0\u5386\u53f2\u6b4c\u66f2"},_w(){if(i.length){let t=i[i.length-1];return"\u4e0b\u4e00\u9996\uff1a"+t.title+"-"+t.artist}return"\u4e0b\u4e00\u9996\uff1a\u968f\u673a\u6b4c\u66f2"},_G(t){this._Z=t,t||this._Y()}},t.Event);